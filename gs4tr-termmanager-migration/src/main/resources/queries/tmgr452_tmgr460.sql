SET FOREIGN_KEY_CHECKS=0;
ALTER TABLE `TM_PROJECT` DROP COLUMN `SEND_TO_DEFAULT_WORKFLOW`;
CREATE TABLE `TM_PROJECT_DETAIL` (`PROJECT_DETAIL_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `ACTIVE_SUBMISSION_COUNT` BIGINT (20) NOT NULL, `APPROVE_TERM_COUNT` BIGINT (20) NOT NULL, `COMPLETED_SUBMISSION_COUNT` BIGINT (20) NOT NULL, `DATE_MODIFIED` datetime NOT NULL, `FORBIDDEN_TERM_COUNT` BIGINT (20) NOT NULL, `TERM_COUNT` BIGINT (20) NOT NULL, `TERMENTRY_COUNT` BIGINT (20) NOT NULL, `TERM_IN_SUBMISSION_COUNT` BIGINT (20) NOT NULL, `LANGUAGE_COUNT` BIGINT (20) NOT NULL, `PROJECT_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`PROJECT_DETAIL_ID`), CONSTRAINT `FKE3421ADDE3A5C25D` FOREIGN KEY (`PROJECT_ID`) REFERENCES `TM_PROJECT` (`PROJECT_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FKE3421ADDE3A5C25D` (`PROJECT_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE UNIQUE INDEX `IDX_PRO_LANG_WFDEF` ON `TM_PROJECT_LANGUAGE`(`PROJECT_ID`, `LANGUAGE_ID`) USING BTREE;
CREATE TABLE `TM_PROJECT_LANGUAGE_DETAIL` (`PROJECT_LANGUAGE_DETAIL_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `ACTIVE_SUBMISSION_COUNT` BIGINT (20) NOT NULL, `APPROVE_TERM_COUNT` BIGINT (20) NOT NULL, `COMPLETED_SUBMISSION_COUNT` BIGINT (20) NOT NULL, `DATE_MODIFIED` datetime NOT NULL, `FORBIDDEN_TERM_COUNT` BIGINT (20) NOT NULL, `TERM_COUNT` BIGINT (20) NOT NULL, `TERMENTRY_COUNT` BIGINT (20) NOT NULL, `TERM_IN_SUBMISSION_COUNT` BIGINT (20) NOT NULL, `DISABLED` bit (1) NOT NULL, `LANGUAGE_ID` VARCHAR (10) NOT NULL, `PROJECT_DETAIL_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`PROJECT_LANGUAGE_DETAIL_ID`), CONSTRAINT `FK9207220C1E4474E9` FOREIGN KEY (`PROJECT_DETAIL_ID`) REFERENCES `TM_PROJECT_DETAIL` (`PROJECT_DETAIL_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FK9207220C1E4474E9` (`PROJECT_DETAIL_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE TABLE `TM_PROJECT_LANGUAGE_USER_DETAIL` (`PROJECT_LANGUAGE_USER_DETAIL_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `ACTIVE_SUBMISSION_COUNT` BIGINT (20) NOT NULL, `COMPLETED_SUBMISSION_COUNT` BIGINT (20) NOT NULL, `PROJECT_LANGUAGE_DETAIL_ID` BIGINT (20) NOT NULL, `USER_PROFILE_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`PROJECT_LANGUAGE_USER_DETAIL_ID`), CONSTRAINT `FKAAD3A26A35FBAD86` FOREIGN KEY (`USER_PROFILE_ID`) REFERENCES `TM_USER_PROFILE` (`USER_PROFILE_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, CONSTRAINT `FKAAD3A26AA96D1DC6` FOREIGN KEY (`PROJECT_LANGUAGE_DETAIL_ID`) REFERENCES `TM_PROJECT_LANGUAGE_DETAIL` (`PROJECT_LANGUAGE_DETAIL_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FKAAD3A26AA96D1DC6` (`PROJECT_LANGUAGE_DETAIL_ID`) USING BTREE, INDEX `FKAAD3A26A35FBAD86` (`USER_PROFILE_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE TABLE `TM_PROJECT_USER_DETAIL` (`PROJECT_USER_DETAIL_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `ACTIVE_SUBMISSION_COUNT` BIGINT (20) NOT NULL, `COMPLETED_SUBMISSION_COUNT` BIGINT (20) NOT NULL, `DATE_MODIFIED` datetime NOT NULL, `TERMENTRY_COUNT` BIGINT (20) NOT NULL, `PROJECT_DETAIL_ID` BIGINT (20) NOT NULL, `USER_PROFILE_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`PROJECT_USER_DETAIL_ID`), CONSTRAINT `FKA45884391E4474E9` FOREIGN KEY (`PROJECT_DETAIL_ID`) REFERENCES `TM_PROJECT_DETAIL` (`PROJECT_DETAIL_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, CONSTRAINT `FKA458843935FBAD86` FOREIGN KEY (`USER_PROFILE_ID`) REFERENCES `TM_USER_PROFILE` (`USER_PROFILE_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FKA45884391E4474E9` (`PROJECT_DETAIL_ID`) USING BTREE, INDEX `FKA458843935FBAD86` (`USER_PROFILE_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE TABLE `TM_SUBMISSION` (`SUBMISSION_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `DATE_MODIFIED` datetime NOT NULL, `DATE_SUBMITTED` datetime NOT NULL, `DATE_COMPLETED` datetime NULL DEFAULT NULL, `PRIORITY` BIGINT (20) NOT NULL, `PRIORITY_ASSIGNEE` BIGINT (20) NOT NULL, `STATUS` VARCHAR (30) NOT NULL, `MARKER_ID` VARCHAR (40) NOT NULL, `NAME` VARCHAR (50) NOT NULL, `SOURCE_LANGUAGE_ID` VARCHAR (10) NOT NULL, `SUBMITTER` VARCHAR (128) NOT NULL, `TERMENTRY_COUNT` BIGINT (20) NOT NULL, `PROJECT_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`SUBMISSION_ID`), CONSTRAINT `FK756B5CD2E3A5C25D` FOREIGN KEY (`PROJECT_ID`) REFERENCES `TM_PROJECT` (`PROJECT_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FK756B5CD2E3A5C25D` (`PROJECT_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE TABLE `TM_SUBMISSION_LANGUAGE` (`SUBMISSION_LANGUAGE_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `ASSIGNEE` VARCHAR (128) NOT NULL, `DATE_MODIFIED` datetime NOT NULL, `DATE_SUBMITTED` datetime NOT NULL, `DATE_COMPLETED` datetime NULL DEFAULT NULL, `PRIORITY` BIGINT (20) NOT NULL, `PRIORITY_ASSIGNEE` BIGINT (20) NOT NULL, `STATUS` VARCHAR (30) NOT NULL, `LANGUAGE_ID` VARCHAR (10) NOT NULL, `MARKER_ID` VARCHAR (40) NOT NULL, `STATUS_ASSIGNEE` VARCHAR (30) NOT NULL, `CANCELED_COUNT` BIGINT (20) NOT NULL, `COMPLETED_COUNT` BIGINT (20) NOT NULL, `TERM_COUNT` BIGINT (20) NOT NULL, `IN_FINAL_REVIEW_COUNT` BIGINT (20) NOT NULL, `IN_TRANSLATION_COUNT` BIGINT (20) NOT NULL, `SUBMISSION_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`SUBMISSION_LANGUAGE_ID`), CONSTRAINT `FKFB8A425558AC9BE` FOREIGN KEY (`SUBMISSION_ID`) REFERENCES `TM_SUBMISSION` (`SUBMISSION_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FKFB8A425558AC9BE` (`SUBMISSION_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE TABLE `TM_SUBMISSION_LANGUAGE_COMMENT` (`COMMENT_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `MARKER_ID` VARCHAR (40) NOT NULL, `TEXT` LONGTEXT NULL, `USER` VARCHAR (40) NOT NULL, `SUBMISSION_LANGUAGE_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`COMMENT_ID`), CONSTRAINT `FKCB9D02598FE1537` FOREIGN KEY (`SUBMISSION_LANGUAGE_ID`) REFERENCES `TM_SUBMISSION_LANGUAGE` (`SUBMISSION_LANGUAGE_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FKCB9D02598FE1537` (`SUBMISSION_LANGUAGE_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE TABLE `TM_SUBMISSION_TERM` (`SUBMISSION_TERM_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `ASSIGNEE` VARCHAR (128) NULL DEFAULT NULL, `CANCELED` bit (1) NOT NULL, `COMMITED` bit (1) NOT NULL, `DATE_MODIFIED` datetime NOT NULL, `DATE_SUBMITTED` datetime NOT NULL, `DATE_COMPLETED` datetime NULL DEFAULT NULL, `PRIORITY` BIGINT (20) NOT NULL, `PRIORITY_ASSIGNEE` BIGINT (20) NOT NULL, `STATUS` VARCHAR (30) NOT NULL, `FORBIDDEN` bit (1) NOT NULL, `IN_TRANSLATION_AS_SOURCE` bit (1) NOT NULL, `LANGUAGE_ID` VARCHAR (10) NOT NULL, `MARKER_ID` VARCHAR (40) NOT NULL, `REVIEW_REQUIRED` bit (1) NULL DEFAULT NULL, `IS_SOURCE` bit (1) NOT NULL, `SUBMISSION_ID` BIGINT (20) NOT NULL, `SUBMISSION_NAME` VARCHAR (50) NOT NULL, `SUBMITTER` VARCHAR (128) NOT NULL, `TERM_TEMP_TEXT` LONGTEXT NULL, `TERMENTRY_ID` BIGINT (20) NULL DEFAULT NULL, `TERM_TEXT` LONGTEXT NULL, `SUBMISSION_LANGUAGE_ID` BIGINT (20) NULL DEFAULT NULL, `TERM_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`SUBMISSION_TERM_ID`), CONSTRAINT `FK9F09CBB998FE1537` FOREIGN KEY (`SUBMISSION_LANGUAGE_ID`) REFERENCES `TM_SUBMISSION_LANGUAGE` (`SUBMISSION_LANGUAGE_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, CONSTRAINT `FK9F09CBB9B368A8BE` FOREIGN KEY (`TERM_ID`) REFERENCES `TM_TERM` (`TERM_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FK9F09CBB998FE1537` (`SUBMISSION_LANGUAGE_ID`) USING BTREE, INDEX `FK9F09CBB9B368A8BE` (`TERM_ID`) USING BTREE, INDEX `IX_SUBMISSION_LANGUAGE_STATUS` (`SUBMISSION_ID`, `LANGUAGE_ID`, `STATUS`) USING BTREE, INDEX `IX_SUBMISSION_LANGUAGE_DATE_MODIFIED` (`SUBMISSION_ID`, `LANGUAGE_ID`, `DATE_MODIFIED`) USING BTREE, INDEX `IX_DATE_MODIFIED` (`DATE_MODIFIED`) USING BTREE, INDEX `IX_LANGUAGE_ID` (`LANGUAGE_ID`) USING BTREE, INDEX `IX_STATUS` (`STATUS`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE TABLE `TM_SUBMISSION_TERM_COMMENT` (`COMMENT_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `MARKER_ID` VARCHAR (40) NOT NULL, `TEXT` LONGTEXT NULL, `USER` VARCHAR (40) NOT NULL, `SUBMISSION_TERM_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`COMMENT_ID`), CONSTRAINT `FKDF8423B92145337` FOREIGN KEY (`SUBMISSION_TERM_ID`) REFERENCES `TM_SUBMISSION_TERM` (`SUBMISSION_TERM_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FKDF8423B92145337` (`SUBMISSION_TERM_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE TABLE `TM_SUBMISSION_TERM_DESCRIPTION` (`DESCRIPTION_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `DESCRIPTION_MARKER` VARCHAR (40) NOT NULL, `DESCRIPTION_TYPE` VARCHAR (40) NOT NULL, `DESCRIPTION_VALUE` LONGTEXT NOT NULL, `BASE_TYPE` INT (11) NOT NULL, `COMMITED` bit (1) NOT NULL, `TEMP_VALUE` LONGTEXT NOT NULL, `SUBMISSION_TERM_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`DESCRIPTION_ID`), CONSTRAINT `FK90D674562145337` FOREIGN KEY (`SUBMISSION_TERM_ID`) REFERENCES `TM_SUBMISSION_TERM` (`SUBMISSION_TERM_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FK90D674562145337` (`SUBMISSION_TERM_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE TABLE `TM_SUBMISSION_USER` (`SUBMISSION_USER_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `DATE_COMPLETED` datetime NULL DEFAULT NULL, `PRIORITY` BIGINT (20) NOT NULL, `PRIORITY_ASSIGNEE` BIGINT (20) NOT NULL, `STATUS` VARCHAR (30) NOT NULL, `SUBMISSION_ID` BIGINT (20) NOT NULL, `USER_PROFILE_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`SUBMISSION_USER_ID`), CONSTRAINT `FK9F0A731835FBAD86` FOREIGN KEY (`USER_PROFILE_ID`) REFERENCES `TM_USER_PROFILE` (`USER_PROFILE_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, CONSTRAINT `FK9F0A7318558AC9BE` FOREIGN KEY (`SUBMISSION_ID`) REFERENCES `TM_SUBMISSION` (`SUBMISSION_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FK9F0A7318558AC9BE` (`SUBMISSION_ID`) USING BTREE, INDEX `FK9F0A731835FBAD86` (`USER_PROFILE_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
ALTER TABLE `TM_TERM` MODIFY COLUMN `STATUS` VARCHAR (30) NOT NULL AFTER `PROJECT_ID`;
ALTER TABLE `TM_TERM` ADD COLUMN `STATUS_OLD` VARCHAR (30) NULL DEFAULT NULL AFTER `STATUS`;
ALTER TABLE `TM_TERM` MODIFY COLUMN `USER_PROFILE_CHANGED` VARCHAR (128) NOT NULL;
ALTER TABLE `TM_TERM_DESCRIPTION` MODIFY COLUMN `TERM_ID` BIGINT (20) NOT NULL AFTER `BASE_TYPE`;
ALTER TABLE `TM_TERMENTRY_AUDIT_METADATA` ADD COLUMN `NEW_STATUS` VARCHAR (30) NULL DEFAULT NULL AFTER `METAKEY`;
ALTER TABLE `TM_TERMENTRY_AUDIT_METADATA` ADD COLUMN `OLD_STATUS` VARCHAR (30) NULL DEFAULT NULL AFTER `NEW_STATUS`;
ALTER TABLE `TM_TERMENTRY_AUDIT_METADATA` MODIFY COLUMN `OLD_VALUE` LONGTEXT NULL;
ALTER TABLE `TM_TERMENTRY_DESCRIPTION` MODIFY COLUMN `TERMENTRY_ID` BIGINT (20) NOT NULL AFTER `DESCRIPTION_VALUE`;
CREATE TABLE `TM_TRANSLATION_HISTORY` (`AUDIT_METADATA_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `AUDIT_DATE` datetime NOT NULL, `OLD_VALUE` LONGTEXT NULL, `VALUE` LONGTEXT NULL, `SUBMISSION_TERM_ID` BIGINT (20) NULL DEFAULT NULL, PRIMARY KEY (`AUDIT_METADATA_ID`), CONSTRAINT `FKC4071E002145337` FOREIGN KEY (`SUBMISSION_TERM_ID`) REFERENCES `TM_SUBMISSION_TERM` (`SUBMISSION_TERM_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FKC4071E002145337` (`SUBMISSION_TERM_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
CREATE TABLE `TM_USER_CUSTOM_SEARCH` (`CUSTOM_SEARCH_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `ADMIN_FOLDER` bit (1) NOT NULL, `CUSTOM_FOLDER` VARCHAR (255) NOT NULL, `ORIGINAL_FOLDER` VARCHAR (255) NOT NULL, `SEARCH_JSON_DATA` LONGTEXT NOT NULL, `URL` VARCHAR (255) NOT NULL, `USER_PROFILE_ID` BIGINT (20) NULL DEFAULT NULL, PRIMARY KEY (`CUSTOM_SEARCH_ID`), CONSTRAINT `FK8CDDCC4835FBAD86` FOREIGN KEY (`USER_PROFILE_ID`) REFERENCES `TM_USER_PROFILE` (`USER_PROFILE_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FK8CDDCC4835FBAD86` (`USER_PROFILE_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;
ALTER TABLE `TM_USER_NOTIFICATION_PROFILES` ADD COLUMN `SEND_TASK_MAIL` bit (1) NULL DEFAULT NULL AFTER `SEND_DAILY_MAIL`;
ALTER TABLE `TM_USER_NOTIFICATION_PROFILES` MODIFY COLUMN `SEND_WEEKLY_MAIL` bit (1) NOT NULL;
ALTER TABLE `TM_USER_PROFILE` MODIFY COLUMN `GENERIC` bit (1) NOT NULL AFTER `USER_PROFILE_ID`;
ALTER TABLE `TM_USER_PROFILE` MODIFY COLUMN `ACCOUNT_NON_EXPIRED` bit (1) NULL DEFAULT NULL AFTER `GENERIC`;
ALTER TABLE `TM_USER_PROFILE` MODIFY COLUMN `GENERIC_PASSWORD` VARCHAR (255) NULL DEFAULT NULL AFTER `USER_TYPE`;
CREATE TABLE `TM_DELETED_TERM` (`TERM_ID` BIGINT (20) NOT NULL AUTO_INCREMENT, `DATE_CREATED` datetime NOT NULL, `DATE_MODIFIED` datetime NOT NULL, `FORBIDDEN` bit (1) NOT NULL, `LANGUAGE_ID` VARCHAR (10) NOT NULL, `MARKER_ID` VARCHAR (40) NOT NULL, `TERM_NAME` LONGTEXT NULL, `PROJECT_ID` BIGINT (20) NOT NULL, `STATUS` VARCHAR (30) NOT NULL, `USER_PROFILE_CHANGED` VARCHAR (128) NOT NULL, `USER_PROFILE_CREATED` VARCHAR (128) NOT NULL, `TICKET` LONGTEXT NULL, `TERMENTRY_ID` BIGINT (20) NOT NULL, PRIMARY KEY (`TERM_ID`), CONSTRAINT `FK68C3B8F8BD8BDFD6` FOREIGN KEY (`TERMENTRY_ID`) REFERENCES `TM_TERMENTRY` (`TERMENTRY_ID`) ON DELETE RESTRICT ON UPDATE RESTRICT, INDEX `FK68C3B8F8BD8BDFD6` (`TERMENTRY_ID`) USING BTREE) ENGINE = INNODB ROW_FORMAT = Compact;

INSERT IGNORE INTO TM_POLICY (POLICY_ID, CATEGORY, POLICY_TYPE) VALUES ('POLICY_TM_ADD_COMMENT', 'Task',	0);
INSERT IGNORE INTO TM_POLICY (POLICY_ID, CATEGORY, POLICY_TYPE) VALUES ('POLICY_TM_CANCEL_TRANSLATION', 'Task',	0);
INSERT IGNORE INTO TM_POLICY (POLICY_ID, CATEGORY, POLICY_TYPE) VALUES ('POLICY_TM_PROJECT_REPORT', 'Task',	0);
INSERT IGNORE INTO TM_POLICY (POLICY_ID, CATEGORY, POLICY_TYPE) VALUES ('POLICY_TM_SEND_TO_TRANSLATION_REVIEW', 'Task',	0);
INSERT IGNORE INTO TM_POLICY (POLICY_ID, CATEGORY, POLICY_TYPE) VALUES ('POLICY_TM_TERM_AUTO_SAVE_TRANSLATION', 'Task',	0);
INSERT IGNORE INTO TM_POLICY (POLICY_ID, CATEGORY, POLICY_TYPE) VALUES ('POLICY_TM_TERM_COMMIT_TRANSLATION_CHANGES', 'Task',	0);
INSERT IGNORE INTO TM_POLICY (POLICY_ID, CATEGORY, POLICY_TYPE) VALUES ('POLICY_TM_TERM_UNDO_TRANSLATION_CHANGES', 'Task',	0);
INSERT IGNORE INTO TM_POLICY (POLICY_ID, CATEGORY, POLICY_TYPE) VALUES ('POLICY_TM_VIEW_TRANSLATOR_INBOX', 'Term',	1);

UPDATE TM_USER_PROFILE SET DATE_PASSWORD_CHANGED = NOW();

INSERT IGNORE INTO TM_USER_PROJECT_ROLE (PROJECT_ID, ROLE_ID, USER_PROFILE_ID) SELECT DISTINCT pul.PROJECT_ID AS PROJECT_ID, 'super_user' AS ROLE_ID, pul.USER_PROFILE_ID AS USER_PROFILE_ID FROM TM_PROJECT_USER_LANGUAGE AS pul INNER JOIN TM_USER_PROFILE AS u ON pul.USER_PROFILE_ID = u.USER_PROFILE_ID INNER JOIN TM_PROJECT AS p ON pul.PROJECT_ID = p.PROJECT_ID WHERE NOT EXISTS (SELECT upr1.PROJECT_ID FROM TM_USER_PROJECT_ROLE AS upr1 WHERE upr1.PROJECT_ID = pul.PROJECT_ID) AND u.GENERIC = 0 AND u.ENABLED = 1 AND u.USER_TYPE = 0 AND p.ENABLED = 1;

UPDATE TM_USER_LANGUAGE SET LANGUAGE_ID = 'sv-FI' WHERE LANGUAGE_ID = 'sv-FL';
UPDATE TM_PROJECT_LANGUAGE SET LANGUAGE_ID = 'sv-FI' WHERE LANGUAGE_ID = 'sv-FL';
UPDATE TM_PROJECT_USER_LANGUAGE SET LANGUAGE_ID = 'sv-FI' WHERE LANGUAGE_ID = 'sv-FL';

INSERT INTO TM_DELETED_TERM (TERM_ID, DATE_CREATED, DATE_MODIFIED, FORBIDDEN, LANGUAGE_ID, MARKER_ID, TERM_NAME, PROJECT_ID, `STATUS`, USER_PROFILE_CHANGED, USER_PROFILE_CREATED, TERMENTRY_ID) SELECT t.TERM_ID AS TERM_ID, t.DATE_CREATED AS DATE_CREATED, t.DATE_MODIFIED AS DATE_MODIFIED, t.FORBIDDEN AS FORBIDDEN, t.LANGUAGE_ID AS LANGUAGE_ID, t.MARKER_ID AS MARKER_ID, t.TERM_NAME AS TERM_NAME, t.PROJECT_ID AS PROJECT_ID, t.`STATUS` AS `STATUS`, t.USER_PROFILE_CHANGED AS USER_PROFILE_CHANGED, t.USER_PROFILE_CREATED AS USER_PROFILE_CREATED, t.TERMENTRY_ID AS TERMENTRY_ID FROM TM_TERM AS t WHERE t.DISABLED = 1;
DELETE FROM TM_TERM_DESCRIPTION WHERE TM_TERM_DESCRIPTION.TERM_ID IN (SELECT TM_TERM.TERM_ID FROM TM_TERM WHERE TM_TERM.DISABLED = 1);
DELETE FROM TM_TERMENTRY_AUDIT_METADATA WHERE TM_TERMENTRY_AUDIT_METADATA.TERM_ID IN (SELECT TM_TERM.TERM_ID FROM TM_TERM WHERE TM_TERM.DISABLED = 1);
DELETE FROM TM_TERM WHERE TM_TERM.DISABLED = 1;

UPDATE TM_TERM t SET t.`STATUS` = 'BLACKLISTED' WHERE t.FORBIDDEN = 1;
UPDATE TM_DELETED_TERM td SET td.`STATUS` = 'BLACKLISTED' WHERE td.FORBIDDEN = 1;

INSERT IGNORE INTO TM_PROJECT_DETAIL (PROJECT_DETAIL_ID, ACTIVE_SUBMISSION_COUNT, APPROVE_TERM_COUNT, COMPLETED_SUBMISSION_COUNT, DATE_MODIFIED, FORBIDDEN_TERM_COUNT, TERM_COUNT, TERMENTRY_COUNT, TERM_IN_SUBMISSION_COUNT, LANGUAGE_COUNT, PROJECT_ID) SELECT TM_PROJECT.PROJECT_ID AS PROJECT_DETAIL_ID, 0 AS ACTIVE_SUBMISSION_COUNT, 0 AS APPROVE_TERM_COUNT, 0 AS COMPLETED_SUBMISSION_COUNT, 0 AS DATE_MODIFIED, 0 AS FORBIDDEN_TERM_COUNT, 0 AS TERM_COUNT, 0 AS TERMENTRY_COUNT, 0 AS TERM_IN_SUBMISSION_COUNT, 0 AS LANGUAGE_COUNT, TM_PROJECT.PROJECT_ID AS PROJECT_ID FROM TM_PROJECT;
UPDATE TM_PROJECT_DETAIL pd SET pd.APPROVE_TERM_COUNT = (SELECT COUNT(t.TERM_ID) FROM TM_TERM t WHERE t.PROJECT_ID = pd.PROJECT_ID AND t.`STATUS` = 'PROCESSED');
UPDATE TM_PROJECT_DETAIL pd SET pd.DATE_MODIFIED = (SELECT MAX(t.DATE_MODIFIED) FROM TM_TERM AS t WHERE pd.PROJECT_ID = t.PROJECT_ID) WHERE pd.PROJECT_ID IN (SELECT DISTINCT t1.PROJECT_ID FROM TM_TERM AS t1);
UPDATE TM_PROJECT_DETAIL pd SET pd.DATE_MODIFIED = NOW() WHERE pd.DATE_MODIFIED = 0;
UPDATE TM_PROJECT_DETAIL pd SET pd.FORBIDDEN_TERM_COUNT = (SELECT COUNT(t.TERM_ID) FROM TM_TERM t WHERE t.PROJECT_ID = pd.PROJECT_ID AND t.FORBIDDEN = 1);
UPDATE TM_PROJECT_DETAIL pd SET pd.TERM_COUNT = (SELECT COUNT(t.TERM_ID) FROM TM_TERM t WHERE t.PROJECT_ID = pd.PROJECT_ID);
UPDATE TM_PROJECT_DETAIL pd SET pd.TERMENTRY_COUNT = (SELECT COUNT(DISTINCT t.TERMENTRY_ID) FROM TM_TERM t WHERE t.PROJECT_ID = pd.PROJECT_ID);
UPDATE TM_PROJECT_DETAIL pd SET pd.LANGUAGE_COUNT = (SELECT COUNT(pl.PROJECT_LANG_ID) FROM TM_PROJECT_LANGUAGE pl WHERE pl.PROJECT_ID = pd.PROJECT_ID);

INSERT IGNORE INTO TM_PROJECT_LANGUAGE_DETAIL (ACTIVE_SUBMISSION_COUNT, APPROVE_TERM_COUNT, COMPLETED_SUBMISSION_COUNT, DATE_MODIFIED, FORBIDDEN_TERM_COUNT, TERM_COUNT, TERMENTRY_COUNT, TERM_IN_SUBMISSION_COUNT, LANGUAGE_ID, PROJECT_DETAIL_ID) SELECT 0 AS ACTIVE_SUBMISSION_COUNT, 0 AS APPROVE_TERM_COUNT, 0 AS COMPLETED_SUBMISSION_COUNT, 0 AS DATE_MODIFIED, 0 AS FORBIDDEN_TERM_COUNT, 0 AS TERM_COUNT, 0 AS TERMENTRY_COUNT, 0 AS TERM_IN_SUBMISSION_COUNT, pl.LANGUAGE_ID AS LANGUAGE_ID, pd.PROJECT_DETAIL_ID AS PROJECT_DETAIL_ID FROM TM_PROJECT_LANGUAGE AS pl INNER JOIN TM_PROJECT AS p ON p.PROJECT_ID = pl.PROJECT_ID INNER JOIN TM_PROJECT_DETAIL AS pd ON pd.PROJECT_ID = p.PROJECT_ID;
UPDATE TM_PROJECT_LANGUAGE_DETAIL pld INNER JOIN TM_PROJECT_DETAIL pd ON pd.PROJECT_DETAIL_ID = pld.PROJECT_DETAIL_ID SET pld.APPROVE_TERM_COUNT = (SELECT COUNT(t.TERM_ID) FROM TM_TERM t WHERE t.PROJECT_ID = pd.PROJECT_ID AND t.`STATUS` = 'PROCESSED' AND t.LANGUAGE_ID = pld.LANGUAGE_ID);
UPDATE TM_PROJECT_LANGUAGE_DETAIL pld INNER JOIN TM_PROJECT_DETAIL pd ON pd.PROJECT_DETAIL_ID = pld.PROJECT_DETAIL_ID SET pld.DATE_MODIFIED = (SELECT MAX(t.DATE_MODIFIED) FROM TM_TERM AS t WHERE pd.PROJECT_ID = t.PROJECT_ID) WHERE pd.PROJECT_ID IN (SELECT DISTINCT t1.PROJECT_ID FROM TM_TERM AS t1);
UPDATE TM_PROJECT_LANGUAGE_DETAIL pld SET pld.DATE_MODIFIED = NOW() WHERE pld.DATE_MODIFIED = 0;
UPDATE TM_PROJECT_LANGUAGE_DETAIL pld INNER JOIN TM_PROJECT_DETAIL pd ON pd.PROJECT_DETAIL_ID = pld.PROJECT_DETAIL_ID SET pld.FORBIDDEN_TERM_COUNT = (SELECT COUNT(t.TERM_ID) FROM TM_TERM t WHERE t.PROJECT_ID = pd.PROJECT_ID AND t.FORBIDDEN = 1 AND t.LANGUAGE_ID = pld.LANGUAGE_ID);
UPDATE TM_PROJECT_LANGUAGE_DETAIL pld INNER JOIN TM_PROJECT_DETAIL pd ON pd.PROJECT_DETAIL_ID = pld.PROJECT_DETAIL_ID SET pld.TERM_COUNT = (SELECT COUNT(t.TERM_ID) FROM TM_TERM t WHERE t.PROJECT_ID = pd.PROJECT_ID AND t.LANGUAGE_ID = pld.LANGUAGE_ID);
UPDATE TM_PROJECT_LANGUAGE_DETAIL pld INNER JOIN TM_PROJECT_DETAIL pd ON pd.PROJECT_DETAIL_ID = pld.PROJECT_DETAIL_ID SET pld.TERMENTRY_COUNT = (SELECT COUNT(DISTINCT t.TERMENTRY_ID) FROM TM_TERM t WHERE t.PROJECT_ID = pd.PROJECT_ID AND t.LANGUAGE_ID = pld.LANGUAGE_ID);

INSERT IGNORE INTO TM_PROJECT_LANGUAGE_USER_DETAIL (ACTIVE_SUBMISSION_COUNT, COMPLETED_SUBMISSION_COUNT, PROJECT_LANGUAGE_DETAIL_ID, USER_PROFILE_ID) SELECT DISTINCT 0 AS ACTIVE_SUBMISSION_COUNT, 0 AS COMPLETED_SUBMISSION_COUNT, pld.PROJECT_LANGUAGE_DETAIL_ID AS PROJECT_LANGUAGE_DETAIL_ID, u.USER_PROFILE_ID AS USER_PROFILE_ID FROM TM_PROJECT_USER_LANGUAGE AS pul INNER JOIN TM_PROJECT AS p ON p.PROJECT_ID = pul.PROJECT_ID INNER JOIN TM_USER_PROFILE AS u ON u.USER_PROFILE_ID = pul.USER_PROFILE_ID INNER JOIN TM_PROJECT_DETAIL AS pd ON pd.PROJECT_ID = p.PROJECT_ID INNER JOIN TM_PROJECT_LANGUAGE_DETAIL AS pld ON pld.PROJECT_DETAIL_ID = pd.PROJECT_DETAIL_ID;
SET FOREIGN_KEY_CHECKS=1;